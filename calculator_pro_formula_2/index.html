<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator Pro Formula 2</title>
<style>
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --input-border: #ddd;
            --button-primary: #3498db;
            --button-primary-hover: #2980b9;
            --button-secondary: #e74c3c;
            --button-secondary-hover: #c0392b;
            --button-success: #27ae60;
            --button-success-hover: #219a52;
            --result-bg: #f8f9fa;
            --error-color: #e74c3c;
            --error-bg: #fadbd8;
            --header-color: #2c3e50;
            --table-header: #34495e;
            --table-row-even: #f8f9fa;
            --table-row-hover: #e3f2fd;
            --menu-bg: #ffffff;
            --menu-border: #e0e0e0;
            --category-bg: #e8f4fd;
            --category-border: #3498db;
            --signature-bg-light: rgba(0, 0, 0, 0.05);
            --signature-text-light: #666;
            --signature-bg-dark: rgba(255, 255, 255, 0.1);
            --signature-text-dark: white;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .dark-mode {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #f0f0f0;
            --input-border: #555;
            --button-primary: #2980b9;
            --button-primary-hover: #3498db;
            --button-secondary: #c0392b;
            --button-secondary-hover: #e74c3c;
            --button-success: #27ae60;
            --button-success-hover: #219a52;
            --result-bg: #3d3d3d;
            --error-color: #ff6b6b;
            --error-bg: #4a2a2a;
            --header-color: #70a1ff;
            --table-header: #404040;
            --table-row-even: #3d3d3d;
            --table-row-hover: #4a4a4a;
            --menu-bg: #3d3d3d;
            --menu-border: #555;
            --category-bg: #2a4d6e;
            --category-border: #3498db;
        }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: Tahoma, Arial, sans-serif;
        background-color: var(--bg-color);
        margin: 0;
        padding: 20px;
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: var(--container-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        position: relative;
        min-height: 60px;
    }

    h1, h2, h3 {
        color: var(--header-color);
        margin: 0 0 15px 0;
    }

    .theme-toggle {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-color);
        transition: transform 0.3s ease;
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        z-index: 101;
        padding: 8px 12px;
    }

    .theme-toggle:hover {
        transform: translateY(-50%) scale(1.1);
        background-color: transparent !important;
    }

    /* استایل‌های تب‌ها - بهبود یافته برای اسکرول */
    .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--input-border);
        overflow-x: auto;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--button-primary) var(--bg-color);
        padding-bottom: 5px;
        cursor: grab;
    }

    .tabs::-webkit-scrollbar {
        height: 8px;
    }

    .tabs::-webkit-scrollbar-track {
        background: var(--bg-color);
        border-radius: 4px;
    }

    .tabs::-webkit-scrollbar-thumb {
        background: var(--button-primary);
        border-radius: 4px;
    }

    .tabs::-webkit-scrollbar-thumb:hover {
        background: var(--button-primary-hover);
    }

    .tabs:active {
        cursor: grabbing;
    }

    .tab {
        padding: 12px 20px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
        position: relative;
    }

    .tab.active {
        background-color: var(--button-primary);
        color: white;
    }

    .tab:hover:not(.active) {
        background-color: var(--result-bg);
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* منوی همبرگری برای موبایل - کاملاً اصلاح شده */
    .mobile-menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: var(--text-color);
        padding: 8px 12px;
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        /* حذف کامل تمام کادرها و effects */
        background-color: transparent !important;
        border: none !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        z-index: 100;
        transition: color 0.3s ease;
    }

    .mobile-menu-toggle:hover {
        background-color: transparent !important;
        transform: translateY(-50%) scale(1.1);
    }

    .mobile-menu-toggle:active,
    .mobile-menu-toggle:focus {
        background-color: transparent !important;
        outline: none;
        border: none !important;
        box-shadow: none !important;
    }

    .mobile-tabs {
        display: none;
        flex-direction: column;
        margin-bottom: 20px;
        background-color: var(--menu-bg);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: 1px solid var(--menu-border);
    }

    .mobile-tab {
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 1px solid var(--input-border);
        transition: all 0.3s ease;
        font-size: 16px;
        font-weight: 500;
    }

    .mobile-tab:last-child {
        border-bottom: none;
    }

    .mobile-tab.active {
        background-color: var(--button-primary);
        color: white;
    }

    .mobile-tab:hover:not(.active) {
        background-color: var(--result-bg);
    }

    .input-group {
        margin-bottom: 20px;
    }

    .input-row {
        display: flex;
        margin-bottom: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
    }

    .input-container {
        flex: 1;
        padding: 0 10px;
        min-width: 200px;
    }

    .results-container {
        flex: 1;
        padding: 0 10px;
        min-width: 200px;
    }

    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    input[type="text"], input[type="date"], input[type="number"], select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
        background-color: var(--container-bg);
        color: var(--text-color);
        transition: border-color 0.3s;
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--button-primary);
    }

    .button-group {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    button {
        padding: 10px 20px;
        background-color: var(--button-primary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: var(--button-primary-hover);
    }

    button.success {
        background-color: var(--button-success);
    }

    button.success:hover {
        background-color: var(--button-success-hover);
    }

    button.danger {
        background-color: var(--button-secondary);
    }

    button.danger:hover {
        background-color: var(--button-secondary-hover);
    }

    #resetBtn {
        background-color: var(--button-secondary);
    }

    #resetBtn:hover {
        background-color: var(--button-secondary-hover);
    }

    .result {
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        background-color: var(--result-bg);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        border: 1px solid var(--input-border);
    }

    .result:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: var(--button-primary);
    }

    .result:active {
        transform: translateY(0);
    }

    .result.copied::after {
        content: "کپی شد!";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(46, 204, 113, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        animation: fadeOut 1.5s forwards;
    }

    @keyframes fadeOut {
        0% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0; }
    }

    .error {
        color: var(--error-color);
        background-color: var(--error-bg);
    }

    .instructions {
        margin-top: 20px;
        padding: 10px;
        background-color: var(--result-bg);
        border-radius: 4px;
        font-size: 14px;
    }

    /* استایل‌های جدول برای دسکتاپ - بهبود یافته برای اسکرول */
    .table-container {
        overflow-x: auto;
        overflow-y: auto; /* تغییر از hidden به auto برای فعال کردن اسکرول عمودی */
        max-height: 60vh; /* محدود کردن ارتفاع برای ایجاد اسکرول عمودی در صورت نیاز */
        margin: 20px 0;
        cursor: grab;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--button-primary) var(--bg-color);
        padding-bottom: 5px;
    }

    .table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .table-container::-webkit-scrollbar-track {
        background: var(--bg-color);
        border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb {
        background: var(--button-primary);
        border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
        background: var(--button-primary-hover);
    }

    .table-container:active {
        cursor: grabbing;
    }

    table {
        width: 200%; /* افزایش عرض برای ایجاد اسکرول افقی واقعی */
        border-collapse: collapse;
        margin: 10px 0;
        min-width: 1200px; /* حداقل عرض برای ستون‌های زیاد */
    }

    th, td {
        padding: 12px 15px;
        text-align: right;
        border-bottom: 1px solid var(--input-border);
        white-space: nowrap;
        user-select: text; /* فعال کردن انتخاب متن */
    }

    th {
        background-color: var(--table-header);
        color: white;
        font-weight: bold;
        position: sticky;
        top: 0;
    }

    tr:nth-child(even) {
        background-color: var(--table-row-even);
    }

    tr:hover {
        background-color: var(--table-row-hover);
    }

    .table-cell {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .table-cell:hover {
        background-color: var(--table-row-hover);
        transform: translateY(-1px);
    }

    .table-cell.copied {
        background-color: var(--success-bg) !important;
        color: var(--success-color) !important;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .action-btn {
        padding: 5px 10px;
        font-size: 12px;
        border-radius: 3px;
    }

    /* استایل‌های کارت برای موبایل */
    .mobile-cards-container {
        display: none;
        flex-direction: column;
        gap: 15px;
        margin: 20px 0;
    }

    .calculation-card {
        background-color: var(--result-bg);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid var(--input-border);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--input-border);
    }

    .card-date {
        font-weight: bold;
        color: var(--header-color);
    }

    .card-currency {
        background-color: var(--button-primary);
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
    }

    .card-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .card-item {
        display: flex;
        flex-direction: column;
    }

    .card-label {
        font-size: 12px;
        color: var(--text-color);
        opacity: 0.7;
        margin-bottom: 3px;
    }

    .card-value {
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: bold;
        font-size: 14px;
        padding: 4px;
        border-radius: 3px;
    }

    .card-value:hover {
        background-color: var(--button-primary);
        color: white;
    }

    .card-value.copied {
        background-color: var(--success-bg) !important;
        color: var(--success-color) !important;
    }

    .card-actions {
        margin-top: 10px;
        display: flex;
        justify-content: flex-end;
        gap: 5px;
    }

    /* استایل‌های بهبود یافته برای مدیریت جفت ارزها */
    .category-section {
        margin: 8px 0;
        padding: 12px;
        background-color: var(--category-bg);
        border-radius: 8px;
        border: 1px solid var(--category-border);
        transition: all 0.3s ease;
    }

    .category-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding: 8px 12px;
        background-color: var(--container-bg);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid var(--input-border);
    }

    .category-header:hover {
        background-color: var(--result-bg);
    }

    .category-title {
        font-size: 16px;
        font-weight: bold;
        color: var(--header-color);
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .category-title::before {
        content: "";
        font-size: 14px;
    }

    .category-actions {
        display: flex;
        gap: 6px;
        flex-wrap: nowrap;
    }

    .category-actions button {
        padding: 6px 8px;
        min-width: auto;
        font-size: 14px;
    }

    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
    }

    .edit-icon {
        background-color: var(--button-primary);
        color: white;
    }

    .edit-icon:hover {
        background-color: var(--button-primary-hover);
    }

    .delete-icon {
        background-color: var(--button-secondary);
        color: white;
    }

    .delete-icon:hover {
        background-color: var(--button-secondary-hover);
    }

    .category-pairs {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-top: 8px;
        transition: all 0.3s ease;
    }

    .category-pairs.collapsed {
        display: none;
    }

    /* استایل‌های بهبود یافته برای آیتم‌های جفت ارز */
    .currency-pair-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 8px;
        margin: 1px 0;
        background-color: var(--result-bg);
        border-radius: 4px;
        border: 1px solid var(--input-border);
        transition: all 0.3s ease;
        min-height: 36px;
        cursor: grab;
    }

    .currency-pair-item:hover {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }

    .currency-pair-item:active {
        cursor: grabbing;
    }

    .currency-pair-item.dragging {
        opacity: 0.5;
        background-color: var(--button-primary);
        color: white;
    }

    .currency-pair-item.drag-over {
        border: 2px dashed var(--button-primary);
        background-color: rgba(52, 152, 219, 0.1);
    }

    .currency-pair-name {
        font-size: 14px;
        font-weight: 500;
        flex: 1;
        text-align: right;
        padding-left: 8px;
    }

    .currency-pair-actions {
        display: flex;
        gap: 4px;
        align-items: center;
        flex-wrap: nowrap;
    }

    .move-buttons {
        display: flex;
        gap: 2px;
        margin-left: 6px;
    }

    .move-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 3px 5px;
        font-size: 11px;
        color: var(--text-color);
        opacity: 0.7;
        transition: all 0.2s ease;
        min-width: 24px;
        border-radius: 3px;
    }

    .move-btn:hover {
        opacity: 1;
        background-color: var(--button-primary);
        color: white;
    }

    .move-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        background-color: transparent;
        color: var(--text-color);
    }

    /* آیکون‌های ویرایش و حذف */
    .action-btn {
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 4px;
        min-width: 50px;
        transition: all 0.2s ease;
    }

    .edit-currency-pair {
        background-color: var(--button-primary);
    }

    .edit-currency-pair:hover {
        background-color: var(--button-primary-hover);
    }

    .delete-currency-pair {
        background-color: var(--button-secondary);
    }

    .delete-currency-pair:hover {
        background-color: var(--button-secondary-hover);
    }

    /* استایل‌های مقایسه - بهبود یافته */
    .comparison-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin: 20px 0;
    }

    .comparison-item {
        flex: 1;
        min-width: 300px;
        padding: 15px;
        background-color: var(--result-bg);
        border-radius: 5px;
        border: 1px solid var(--input-border);
    }

    .comparison-dates-container {
        margin: 15px 0;
    }

    .comparison-date-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .comparison-date-input {
        flex: 1;
    }

    .remove-date-btn {
        background-color: var(--button-secondary);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        padding: 8px 12px;
        font-size: 14px;
    }

    .remove-date-btn:hover {
        background-color: var(--button-secondary-hover);
    }

    /* استایل‌های مودال */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1100;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background-color: var(--container-bg);
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-color);
    }

    .form-group {
        margin-bottom: 15px;
    }

    /* استایل‌های اعلان */
    .notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 20px;
        background-color: var(--button-success);
        color: white;
        border-radius: 5px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1200;
        display: flex;
        align-items: center;
        gap: 10px;
        max-width: 400px;
        animation: slideDown 0.3s ease;
    }

    .notification.error {
        background-color: var(--error-color);
    }

    .notification.warning {
        background-color: #f39c12;
    }

    @keyframes slideDown {
        from {
            top: -100px;
            opacity: 0;
        }
        to {
            top: 20px;
            opacity: 1;
        }
    }

    .notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        margin-right: auto;
    }

    /* استایل‌های فیلتر و جستجو */
    .filter-container {
        display: flex;
        gap: 10px;
        margin: 15px 0;
        flex-wrap: wrap;
    }

    .filter-item {
        flex: 1;
        min-width: 150px;
    }

    /* استایل‌های ریسپانسیو */
    @media (max-width: 768px) {
        body {
            padding: 10px;
        }
        
        .container {
            padding: 15px;
        }
        
        .header {
            flex-direction: row;
            align-items: center;
            padding-left: 45px;
            padding-right: 45px;
            min-height: 50px;
        }
        
        .input-row {
            flex-direction: column;
        }
        
        .input-container, .results-container {
            width: 100%;
            padding: 0;
            margin-bottom: 10px;
        }
        
        .button-group {
            flex-direction: column;
        }
        
        .button-group button {
            width: 100%;
        }
        
        .filter-container {
            flex-direction: column;
        }
        
        .filter-item {
            width: 100%;
        }
        
        /* نمایش کارت‌ها در موبایل و مخفی کردن جدول */
        .table-container {
            display: none;
        }
        
        .mobile-cards-container {
            display: flex;
        }
        
        .comparison-item {
            min-width: 100%;
        }
        
        h1 {
            font-size: 18px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
            padding: 0 10px;
            line-height: 1.2;
        }

        .tabs {
            display: none;
            cursor: default;
        }
        
        .mobile-menu-toggle {
            display: block;
        }
        
        .mobile-tabs {
            display: none;
        }
        
        /* بهبود نمایش جفت ارزها در موبایل */
        .category-section {
            padding: 10px;
            margin: 6px 0;
        }
        
        .category-header {
            padding: 6px 10px;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }
        
        .category-actions {
            justify-content: flex-end;
        }
        
        .currency-pair-item {
            padding: 5px 6px;
            flex-direction: row;
            align-items: center;
            gap: 4px;
            min-height: 32px;
            cursor: default;
        }
        
        .currency-pair-name {
            font-size: 12px;
            padding-left: 4px;
        }
        
        .currency-pair-actions {
            flex-direction: row;
            gap: 2px;
        }
        
        .action-btn {
            padding: 3px 6px;
            font-size: 10px;
            min-width: 40px;
        }
        
        .move-buttons {
            margin-left: 4px;
            gap: 1px;
        }
        
        .move-btn {
            padding: 2px 3px;
            font-size: 9px;
            min-width: 20px;
        }

        .icon-btn {
            padding: 5px 6px;
            min-width: 28px;
            font-size: 12px;
        }
    }

    @media (max-width: 480px) {
        .container {
            padding: 10px;
        }
        
        .modal-content {
            padding: 15px;
            width: 95%;
        }
        
        .card-content {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .header {
            padding-left: 40px;
            padding-right: 40px;
            min-height: 45px;
        }
        
        h1 {
            font-size: 16px;
            margin: 0 2px;
            padding: 0 5px;
        }
        
        /* بهبود بیشتر برای موبایل‌های کوچک */
        .currency-pair-item {
            padding: 4px 5px;
        }
        
        .currency-pair-name {
            font-size: 11px;
        }
        
        .action-btn {
            padding: 2px 4px;
            font-size: 9px;
            min-width: 35px;
        }
        
        .move-btn {
            padding: 1px 2px;
            font-size: 8px;
            min-width: 18px;
        }

        .mobile-menu-toggle {
            font-size: 24px;
            padding: 6px 10px;
        }

        .theme-toggle {
            font-size: 20px;
            padding: 6px 10px;
        }
    }

    /* نمایش هر دو حالت در دسکتاپ */
    @media (min-width: 769px) {
        .mobile-cards-container {
            display: none !important;
        }
        
        .table-container {
            display: block !important;
            cursor: grab;
        }
        
        .mobile-menu-toggle,
        .mobile-tabs {
            display: none !important;
        }
        
        .tabs {
            display: flex !important;
            cursor: grab;
        }
        
        .currency-pair-name {
            font-size: 16px;
        }
    }

    /* استایل‌های جدید برای حذف دسته‌بندی */
    .delete-options {
        margin: 15px 0;
        padding: 15px;
        background-color: var(--result-bg);
        border-radius: 5px;
        border: 1px solid var(--input-border);
    }

    .delete-option {
        margin: 10px 0;
    }

    .delete-option label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: normal;
    }

    .delete-option input[type="radio"] {
        width: auto;
        margin: 0;
    }
    
.signature {
    color: var(--signature-text-light);
    text-align: center;
    padding: 16px;
    font-family: Vazirmatn, system-ui;
    background: var(--signature-bg-light);
    border-radius: 10px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    font-size: 14px;
    font-weight: 500;
    display: block;
    margin: 30px auto;
    width: fit-content;
    max-width: 90%;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

.dark-mode .signature {
    color: var(--signature-text-dark);
    background: var(--signature-bg-dark);
    border: 1px solid rgba(255, 255, 255, 0.2);
}@media
 only screen and (max-width: 768px) {
    .signature {
        font-size: 14px;
        padding: 15px;
    }
}@media
 only screen and (max-width: 480px) {
    .signature {
        font-size: 12px;
        padding: 13px;
    }
}
    </style></head>
<body>
    <div class="container">
        <div class="header">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
            <h1>Calculator Pro Formula 2</h1>
            <button class="theme-toggle" id="themeToggle"></button>
        </div>
               <HR>
        <BR>
        <!-- منوی همبرگری برای موبایل -->
        <div class="mobile-tabs" id="mobileTabs">
            <div class="mobile-tab active" data-tab="calculator">ماشین حساب</div>
            <div class="mobile-tab" data-tab="history">تاریخچه محاسبات</div>
            <div class="mobile-tab" data-tab="comparison">مقایسه داده‌ها</div>
            <div class="mobile-tab" data-tab="currency-pairs">مدیریت جفت ارزها</div>
            <div class="mobile-tab" data-tab="backup">پشتیبان‌گیری</div>
            <div class="mobile-tab" data-tab="delete-records">حذف رکورد</div>
        </div>
        

    
    <!-- تب‌های اصلی -->
    <div class="tabs" id="tabs">
        <div class="tab active" data-tab="calculator">ماشین حساب</div>
        <div class="tab" data-tab="history">تاریخچه محاسبات</div>
        <div class="tab" data-tab="comparison">مقایسه داده‌ها</div>
        <div class="tab" data-tab="currency-pairs">مدیریت جفت ارزها</div>
        <div class="tab" data-tab="backup">پشتیبان‌گیری</div>
        <div class="tab" data-tab="delete-records">حذف رکورد</div>
    </div>
    
    <!-- تب ماشین حساب -->
    <div class="tab-content active" id="calculator-tab">
        <h2>محاسبه فرمول‌ها</h2>
        
        <div class="form-group">
            <label for="currencyPairSelect">جفت ارز:</label>
            <select id="currencyPairSelect">
                <option value="">-- انتخاب جفت ارز --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="calculationDate">تاریخ محاسبه:</label>
            <input type="date" id="calculationDate">
        </div>
        
        <div class="input-group">
            <div class="input-row">
                <div class="input-container">
                    <label for="inputY1">سقف</label>
                    <input type="text" id="inputY1" placeholder="سقف را وارد کنید">
                </div>
                <div class="results-container">
                    <div id="outputFormula1" class="result"></div>
                    <div id="outputFormula2" class="result"></div>
                </div>
            </div>
            
            <div class="input-row">
                <div class="input-container">
                    <label for="inputY2">کف</label>
                    <input type="text" id="inputY2" placeholder="کف را وارد کنید">
                </div>
                <div class="results-container">
                    <div id="outputFormula3" class="result"></div>
                    <div id="outputFormula4" class="result"></div>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="calculateBtn">محاسبه و ذخیره</button>
            <button id="resetBtn">ریست</button>
        </div>

        <div class="instructions">
            <p><strong>راهنما:</strong></p>
            <ul>
                <li>برای کپی کردن نتیجه، روی آن کلیک کنید</li>
                <li>برای تغییر حالت تاریک/روشن، روی آیکون ماه کلیک کنید</li>
                <li>حتماً جفت ارز و تاریخ را انتخاب کنید تا داده ذخیره شود</li>
                <li>اعداد را با نقطه جدا کنید (مثال: 91.325)</li>
            </ul>
        </div>
    </div>
    
    <!-- تب تاریخچه محاسبات -->
    <div class="tab-content" id="history-tab">
        <h2>تاریخچه محاسبات</h2>
        
        <div class="filter-container">
            <div class="filter-item">
                <label for="filterCurrencyPair">جفت ارز:</label>
                <select id="filterCurrencyPair">
                    <option value="">همه جفت ارزها</option>
                </select>
            </div>
            
            <div class="filter-item">
                <label for="filterDate">تاریخ:</label>
                <input type="date" id="filterDate">
            </div>
        </div>
        
        <!-- جدول برای دسکتاپ -->
        <div class="table-container">
            <table id="calculationsTable">
                <thead>
                    <tr>
                        <th>تاریخ</th>
                        <th>جفت ارز</th>
                        <th>سقف</th>
                        <th>کف</th>
                        <th>فرمول ۱</th>
                        <th>فرمول ۲</th>
                        <th>فرمول ۳</th>
                        <th>فرمول ۴</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody id="calculationsTableBody">
                    <!-- داده‌ها اینجا نمایش داده می‌شوند -->
                </tbody>
            </table>
        </div>
        
        <!-- کارت‌ها برای موبایل -->
        <div class="mobile-cards-container" id="mobileCardsContainer">
            <!-- کارت‌ها اینجا نمایش داده می‌شوند -->
        </div>
        
        <div id="noDataMessage" style="text-align: center; padding: 20px; display: none;">
            هیچ داده‌ای یافت نشد.
        </div>
        
        <!-- پیام جدید برای زمانی که تاریخ انتخاب نشده -->
        <div id="selectDateMessage" style="text-align: center; padding: 20px; display: none;">
            <p style="color: var(--error-color); font-weight: bold;">لطفاً تاریخ را انتخاب کنید تا داده‌ها نمایش داده شوند.</p>
        </div>
    </div>
    
    <!-- تب مقایسه داده‌ها -->
    <div class="tab-content" id="comparison-tab">
        <h2>مقایسه داده‌ها</h2>
        
        <div class="form-group">
            <label for="comparisonCurrencyPair">جفت ارز برای مقایسه:</label>
            <select id="comparisonCurrencyPair">
                <option value="">-- انتخاب جفت ارز --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>انتخاب تاریخ برای مقایسه:</label>
            <div id="comparisonDatesContainer" class="comparison-dates-container">
                <div class="comparison-date-row">
                    <div class="comparison-date-input">
                        <input type="date" class="comparison-date">
                    </div>
                    <button type="button" class="remove-date-btn" style="display: none;">×</button>
                </div>
            </div>
            <button type="button" id="addDateBtn" class="success">+ افزودن تاریخ</button>
        </div>
        
        <div class="button-group">
            <button id="compareDataBtn">مقایسه داده‌ها</button>
            <button id="clearComparisonBtn" class="danger">پاک کردن</button>
        </div>
        
        <div id="comparisonResults" class="comparison-container">
            <!-- نتایج مقایسه اینجا نمایش داده می‌شوند -->
        </div>
    </div>
    
    <!-- تب مدیریت جفت ارزها -->
    <div class="tab-content" id="currency-pairs-tab">
        <h2>مدیریت جفت ارزها و دسته‌بندی‌ها</h2>
        <BR>
        <!-- بخش افزودن دسته‌بندی جدید -->
        <div class="form-group">
            <h3><li>افزودن دسته‌بندی جدید</li></h3>
            <label for="newCategoryName">نام دسته‌بندی:</label>
            <input type="text" id="newCategoryName" placeholder="مثلاً: فارکس، ارز دیجیتال">
            <button id="addCategoryBtn" class="success" style="margin-top: 5px;">افزودن دسته‌بندی</button>
        </div>
        
        <!-- بخش افزودن جفت ارز جدید -->
        <div class="form-group">
            <h3><li>افزودن جفت ارز جدید</li></h3>
            <label for="newCurrencyPair">جفت ارز جدید:</label>
            <input type="text" id="newCurrencyPair" placeholder="مثلاً: EUR/USD">
        </div>

        <div class="form-group">
            <label for="currencyPairCategory">دسته‌بندی:</label>
            <select id="currencyPairCategory">
                <option value="">-- انتخاب دسته‌بندی --</option>
            </select>
        </div>
        
        <div class="button-group">
            <button id="addCurrencyPairBtn" class="success">افزودن جفت ارز</button>
        </div>
        <BR>
        <!-- بخش نمایش دسته‌بندی‌ها و جفت ارزها -->
        <h3><li>دسته‌بندی‌ها و جفت ارزهای موجود</li></h3>
        <div id="currencyPairsList">
            <!-- لیست دسته‌بندی‌ها و جفت ارزها اینجا نمایش داده می‌شوند -->
        </div>
    </div>
    
    <!-- تب پشتیبان‌گیری -->
    <div class="tab-content" id="backup-tab">
        <h2>پشتیبان‌گیری و بازیابی</h2>
        
        <div class="instructions">
            <p>از این بخش می‌توانید از تمام داده‌های خود پشتیبان بگیرید یا داده‌های قبلی را بازیابی کنید.</p>
        </div>
        
        <div class="button-group">
            <button id="backupDataBtn" class="success">دانلود پشتیبان</button>
            <button id="restoreDataBtn">بازیابی داده‌ها</button>
        </div>
        
        <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
        
        <div class="instructions" style="margin-top: 20px;">
            <p><strong>توجه:</strong> فایل پشتیبان شامل تمام جفت ارزها، تاریخچه محاسبات و تنظیمات شما خواهد بود.</p>
        </div>
    </div>
    
    <!-- تب حذف رکورد -->
    <div class="tab-content" id="delete-records-tab">
        <h2>حذف رکوردها</h2>
        
        <div class="instructions">
            <p>از این بخش می‌توانید رکوردهای قدیمی را به دو روش حذف کنید:</p>
        </div>
        <BR>
        <div class="form-group">
            <h3><li>حذف بر اساس تاریخ</li></h3>
            <label for="deleteBeforeDate">حذف داده‌های قبل از تاریخ:</label>
            <input type="date" id="deleteBeforeDate">
            <button id="deleteByDateBtn" class="danger" style="margin-top: 10px;">حذف داده‌های قبل از این تاریخ</button>
        </div>
        
        <div class="form-group">
            <h3><li>حذف بر اساس تعداد روز</li></h3>
            <label for="deleteDays">حذف داده‌های قدیمی‌تر از (روز):</label>
            <input type="number" id="deleteDays" min="1" max="365" value="30" placeholder="تعداد روز">
            <button id="deleteByDaysBtn" class="danger" style="margin-top: 10px;">حذف داده‌های قدیمی</button>
        </div>
        
        <div class="instructions" style="margin-top: 20px;">
            <p><strong>هشدار:</strong> عملیات حذف قابل بازگشت نیست. قبل از حذف از داده‌های خود پشتیبان بگیرید.</p>
        </div>
    </div>
    
    <div class="signature">
        طراحی و ساخت توسط ⦙ سعید شیخ احمد صفاری
    </div>
</div>

<!-- مودال برای ویرایش جفت ارز -->
<div class="modal" id="editCurrencyPairModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ویرایش جفت ارز</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="form-group">
            <label for="editCurrencyPairInput">نام جفت ارز:</label>
            <input type="text" id="editCurrencyPairInput">
        </div>
        <div class="form-group">
            <label for="editCurrencyPairCategory">دسته‌بندی:</label>
            <select id="editCurrencyPairCategory">
                <option value="">-- انتخاب دسته‌بندی --</option>
            </select>
        </div>
        <div class="button-group">
            <button id="saveCurrencyPairEditBtn" class="success">ذخیره تغییرات</button>
            <button class="close-modal danger">انصراف</button>
        </div>
    </div>
</div>

<!-- مودال برای ویرایش دسته‌بندی -->
<div class="modal" id="editCategoryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ویرایش دسته‌بندی</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="form-group">
            <label for="editCategoryInput">نام دسته‌بندی:</label>
            <input type="text" id="editCategoryInput">
        </div>
        <div class="button-group">
            <button id="saveCategoryEditBtn" class="success">ذخیره تغییرات</button>
            <button class="close-modal danger">انصراف</button>
        </div>
    </div>
</div>

<!-- مودال برای ویرایش محاسبه -->
<div class="modal" id="editCalculationModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ویرایش محاسبه</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="form-group">
            <label for="editCalculationDate">تاریخ:</label>
            <input type="date" id="editCalculationDate">
        </div>
        <div class="form-group">
            <label for="editCurrencyPair">جفت ارز:</label>
            <input type="text" id="editCurrencyPair" readonly>
        </div>
        <div class="form-group">
            <label for="editInputY1">سقف:</label>
            <input type="text" id="editInputY1">
        </div>
        <div class="form-group">
            <label for="editInputY2">کف:</label>
            <input type="text" id="editInputY2">
        </div>
        <div class="button-group">
            <button id="saveCalculationEditBtn" class="success">ذخیره تغییرات</button>
            <button class="close-modal danger">انصراف</button>
        </div>
    </div>
</div>

<!-- مودال برای تأیید حذف -->
<div class="modal" id="confirmDeleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>تأیید حذف</h3>
            <button class="close-modal">&times;</button>
        </div>
        <p id="confirmDeleteMessage">آیا از حذف این آیتم مطمئن هستید؟</p>
        <div class="button-group">
            <button id="confirmDeleteBtn" class="danger">بله، حذف شود</button>
            <button class="close-modal">انصراف</button>
        </div>
    </div>
</div>

<!-- مودال جدید برای حذف دسته‌بندی -->
<div class="modal" id="deleteCategoryModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>حذف دسته‌بندی</h3>
            <button class="close-modal">&times;</button>
        </div>
        <p id="deleteCategoryMessage">لطفاً گزینه حذف را انتخاب کنید:</p>
        
        <div class="delete-options">
            <div class="delete-option">
                <label>
                    <input type="radio" name="deleteOption" value="categoryOnly" checked>
                    فقط دسته‌بندی را حذف کن (جفت ارزها بدون دسته‌بندی می‌مانند)
                </label>
            </div>
            <div class="delete-option">
                <label>
                    <input type="radio" name="deleteOption" value="categoryWithPairs">
                    دسته‌بندی و تمام جفت ارزهای داخل آن را حذف کن
                </label>
            </div>
        </div>
        
        <div class="button-group">
            <button id="confirmCategoryDeleteBtn" class="danger">حذف</button>
            <button class="close-modal">انصراف</button>
        </div>
    </div>
</div>

<script>
    // پایگاه داده
    let db;
    const DB_NAME = 'CurrencyCalculatorDB';
    const DB_VERSION = 2;
    
    // نام جداول پایگاه داده
    const STORE_CALCULATIONS = 'calculations';
    const STORE_CURRENCY_PAIRS = 'currency_pairs';
    const STORE_CATEGORIES = 'categories';
    const STORE_SETTINGS = 'settings';
    
    // متغیرهای عمومی
    let currentEditId = null;
    let deleteCallback = null;
    let currentEditType = null;
    let currentDeleteCategoryId = null;

    // متغیرهای اسکرول پیشرفته
    let isDragging = false;
    let startX = 0;
    let scrollLeft = 0;
    let isDesktopOrTablet = window.matchMedia('(min-width: 769px)').matches;
    const tabs = document.getElementById('tabs');

    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        setupAdvancedScroll();
        setupTableScroll();
    });

    // تابع تنظیم اسکرول پیشرفته برای تب‌ها
    function setupAdvancedScroll() {
        // Wheel event برای اسکرول افقی با چرخ موس
        tabs.addEventListener('wheel', handleWheel, { passive: false });

        // Drag events
        tabs.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', doDrag);
        document.addEventListener('mouseup', endDrag);

        // Hover روی تب‌ها برای تغییر cursor
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('mouseenter', () => {
                if (isDesktopOrTablet) {
                    tabs.style.cursor = 'grab';
                }
            });
            tab.addEventListener('mouseleave', () => {
                if (!isDragging && isDesktopOrTablet) {
                    tabs.style.cursor = 'grab'; // یا default اگر لازم
                }
            });
        });

        // به‌روزرسانی تشخیص اندازه صفحه
        window.addEventListener('resize', () => {
            isDesktopOrTablet = window.matchMedia('(min-width: 769px)').matches;
            if (!isDesktopOrTablet) {
                endDrag();
                tabs.style.cursor = 'default';
            } else {
                tabs.style.cursor = 'grab';
            }
        });
    }

    // تابع wheel برای تب‌ها
    function handleWheel(e) {
        if (!isDesktopOrTablet) return;
        e.preventDefault();
        const delta = e.deltaY > 0 ? 50 : -50; // سرعت اسکرول
        tabs.scrollLeft += delta;
    }

    // Drag functions برای تب‌ها
    function startDrag(e) {
        if (!isDesktopOrTablet) return;
        isDragging = true;
        startX = e.pageX - tabs.offsetLeft;
        scrollLeft = tabs.scrollLeft;
        tabs.style.cursor = 'grabbing';
        e.preventDefault();
    }

    function doDrag(e) {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - tabs.offsetLeft;
        const walk = (x - startX) * 2; // سرعت drag
        tabs.scrollLeft = scrollLeft - walk;
    }

    function endDrag() {
        isDragging = false;
        if (isDesktopOrTablet) {
            tabs.style.cursor = 'grab';
        }
    }

    // تابع تنظیم اسکرول پیشرفته برای جدول تاریخچه
    function setupTableScroll() {
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) return;

        let isDraggingTable = false;
        let startXTable = 0;
        let scrollLeftTable = 0;

        // Wheel event: هندل کردن هر دو جهت اسکرول (عمودی و افقی) بدون تداخل
        tableContainer.addEventListener('wheel', (e) => {
            e.preventDefault(); // جلوگیری از اسکرول پیش‌فرض صفحه
            if (e.deltaY !== 0) {
                // اسکرول عمودی: مستقیم به scrollTop
                tableContainer.scrollTop += e.deltaY;
            }
            if (e.deltaX !== 0) {
                // اسکرول افقی: مستقیم به scrollLeft
                tableContainer.scrollLeft += e.deltaX;
            }
        }, { passive: false });

        // شروع drag برای اسکرول افقی
        tableContainer.addEventListener('mousedown', (e) => {
            if (!isDesktopOrTablet) return;
            isDraggingTable = true;
            startXTable = e.pageX - tableContainer.offsetLeft;
            scrollLeftTable = tableContainer.scrollLeft;
            tableContainer.style.cursor = 'grabbing';
            e.preventDefault();
        });

        // در حین drag
        document.addEventListener('mousemove', (e) => {
            if (!isDraggingTable) return;
            e.preventDefault();
            const x = e.pageX - tableContainer.offsetLeft;
            const walk = (x - startXTable) * 2; // سرعت drag (قابل تنظیم)
            tableContainer.scrollLeft = scrollLeftTable - walk;
        });

        // پایان drag
        document.addEventListener('mouseup', () => {
            isDraggingTable = false;
            if (isDesktopOrTablet) {
                tableContainer.style.cursor = 'grab';
            }
        });

        tableContainer.addEventListener('mouseleave', () => {
            isDraggingTable = false;
            if (isDesktopOrTablet) {
                tableContainer.style.cursor = 'grab';
            }
        });

        // برای تبلت/لمس: swipe افقی طبیعی
        tableContainer.addEventListener('touchstart', (e) => {
            startXTable = e.touches[0].pageX - tableContainer.offsetLeft;
            scrollLeftTable = tableContainer.scrollLeft;
        });

        tableContainer.addEventListener('touchmove', (e) => {
            const x = e.touches[0].pageX - tableContainer.offsetLeft;
            const walk = (x - startXTable) * 2;
            tableContainer.scrollLeft = scrollLeftTable - walk;
            e.preventDefault(); // جلوگیری از اسکرول صفحه
        }, { passive: false });

        // به‌روزرسانی cursor بر اساس اندازه صفحه
        window.addEventListener('resize', () => {
            isDesktopOrTablet = window.matchMedia('(min-width: 769px)').matches;
            tableContainer.style.cursor = isDesktopOrTablet ? 'grab' : 'default';
            if (!isDesktopOrTablet) {
                isDraggingTable = false;
            }
        });
    }

    // تابع کپی کردن متن (بهبود یافته برای جدول و کارت‌ها)
    function copyToClipboard(element, text = null) {
        const textToCopy = text || element.textContent.trim() || element.dataset.value;
        
        if (!textToCopy) return;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            element.classList.add('copied');
            showNotification('کپی شد! (' + textToCopy + ')', 'success', 2000);
            setTimeout(() => {
                element.classList.remove('copied');
            }, 1500);
        }).catch(err => {
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            element.classList.add('copied');
            showNotification('کپی شد! (' + textToCopy + ')', 'success', 2000);
            setTimeout(() => {
                element.classList.remove('copied');
            }, 1500);
        });
    }

    // تابع نمایش اعلان
    function showNotification(message, type = 'success', duration = 3000) {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        `;
        
        document.body.appendChild(notification);
        
        notification.querySelector('.notification-close').addEventListener('click', function() {
            notification.remove();
        });
        
        if (duration > 0) {
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }
    }

    // تابع مقداردهی اولیه برنامه
    async function initializeApp() {
        await initializeDatabase();
        await loadCategories();
        await loadCurrencyPairs();
        setupEventListeners();
        setDefaultDate();
        loadCalculationsTable();
        
        document.getElementById('filterCurrencyPair').addEventListener('change', loadCalculationsTable);
        document.getElementById('filterDate').addEventListener('change', loadCalculationsTable);
    }

    // تابع راه‌اندازی پایگاه داده
    function initializeDatabase() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            
            request.onerror = () => {
                console.error('خطا در باز کردن پایگاه داده');
                reject('خطا در باز کردن پایگاه داده');
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                
                if (!db.objectStoreNames.contains(STORE_CALCULATIONS)) {
                    const calculationsStore = db.createObjectStore(STORE_CALCULATIONS, { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    calculationsStore.createIndex('date', 'date', { unique: false });
                    calculationsStore.createIndex('currencyPair', 'currencyPair', { unique: false });
                }
                
                if (!db.objectStoreNames.contains(STORE_CURRENCY_PAIRS)) {
                    const currencyPairsStore = db.createObjectStore(STORE_CURRENCY_PAIRS, { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    currencyPairsStore.createIndex('name', 'name', { unique: true });
                    currencyPairsStore.createIndex('order', 'order', { unique: false });
                    currencyPairsStore.createIndex('categoryId', 'categoryId', { unique: false });
                }
                
                if (!db.objectStoreNames.contains(STORE_CATEGORIES)) {
                    const categoriesStore = db.createObjectStore(STORE_CATEGORIES, { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    categoriesStore.createIndex('name', 'name', { unique: true });
                    categoriesStore.createIndex('order', 'order', { unique: false });
                }
                
                if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                    const settingsStore = db.createObjectStore(STORE_SETTINGS, { 
                        keyPath: 'id'
                    });
                }
            };
        });
    }

    // تابع ذخیره داده در پایگاه داده
    function saveToDatabase(storeName, data) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put(data);
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    // تابع خواندن همه داده‌ها از پایگاه داده
    function getAllFromDatabase(storeName, indexName = null, query = null) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = indexName ? store.index(indexName).getAll(query) : store.getAll();
            
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    // تابع حذف داده از پایگاه داده
    function deleteFromDatabase(storeName, id) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.delete(id);
            
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }

    // تابع تنظیم تاریخ پیش‌فرض به امروز (میلادی)
    function setDefaultDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('calculationDate').value = today;
    }

    // تابع بارگذاری دسته‌بندی‌ها
    async function loadCategories() {
        try {
            let categories = await getAllFromDatabase(STORE_CATEGORIES);
            categories.sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const categorySelect = document.getElementById('currencyPairCategory');
            const editCategorySelect = document.getElementById('editCurrencyPairCategory');
            
            while (categorySelect.children.length > 1) {
                categorySelect.removeChild(categorySelect.lastChild);
            }
            while (editCategorySelect.children.length > 1) {
                editCategorySelect.removeChild(editCategorySelect.lastChild);
            }
            
            categories.forEach(category => {
                const option1 = document.createElement('option');
                option1.value = category.id;
                option1.textContent = category.name;
                categorySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = category.id;
                option2.textContent = category.name;
                editCategorySelect.appendChild(option2);
            });
        } catch (error) {
            console.error('خطا در بارگذاری دسته‌بندی‌ها:', error);
        }
    }

    // تابع اضافه کردن دسته‌بندی جدید
    async function addCategory() {
        const newCategoryInput = document.getElementById('newCategoryName');
        const categoryName = newCategoryInput.value.trim();
        
        if (!categoryName) {
            showNotification('لطفاً نام دسته‌بندی را وارد کنید.', 'warning');
            return;
        }
        
        try {
            const categories = await getAllFromDatabase(STORE_CATEGORIES);
            const maxOrder = categories.length > 0 ? Math.max(...categories.map(c => c.order || 0)) : -1;
            
            await saveToDatabase(STORE_CATEGORIES, {
                name: categoryName,
                order: maxOrder + 1,
                createdAt: new Date().toISOString()
            });
            
            newCategoryInput.value = '';
            await loadCategories();
            await loadCurrencyPairs();
            showNotification('دسته‌بندی با موفقیت اضافه شد.');
        } catch (error) {
            console.error('خطا در اضافه کردن دسته‌بندی:', error);
            if (error.name === 'ConstraintError') {
                showNotification('این دسته‌بندی قبلاً وجود دارد.', 'error');
            } else {
                showNotification('خطا در اضافه کردن دسته‌بندی.', 'error');
            }
        }
    }

    // تابع باز کردن مودال ویرایش دسته‌بندی
    function openEditCategoryModal(id, name) {
        currentEditId = id;
        currentEditType = 'category';
        document.getElementById('editCategoryInput').value = name;
        document.getElementById('editCategoryModal').style.display = 'flex';
    }

    // تابع ذخیره ویرایش دسته‌بندی
    async function saveCategoryEdit() {
        const newName = document.getElementById('editCategoryInput').value.trim();
        
        if (!newName) {
            showNotification('لطفاً نام دسته‌بندی را وارد کنید.', 'warning');
            return;
        }
        
        try {
            const categories = await getAllFromDatabase(STORE_CATEGORIES);
            const existingCategory = categories.find(c => c.id === parseInt(currentEditId));
            
            if (existingCategory) {
                await saveToDatabase(STORE_CATEGORIES, {
                    ...existingCategory,
                    name: newName
                });
                
                closeModals();
                await loadCategories();
                await loadCurrencyPairs();
                showNotification('دسته‌بندی با موفقیت ویرایش شد.');
            }
        } catch (error) {
            console.error('خطا در ویرایش دسته‌بندی:', error);
            if (error.name === 'ConstraintError') {
                showNotification('این دسته‌بندی قبلاً وجود دارد.', 'error');
            } else {
                showNotification('خطا در ویرایش دسته‌بندی.', 'error');
            }
        }
    }

    // تابع باز کردن مودال حذف دسته‌بندی
    function openDeleteCategoryModal(id, name) {
        currentDeleteCategoryId = id;
        document.getElementById('deleteCategoryMessage').textContent = 
            `لطفاً گزینه حذف را برای دسته‌بندی "${name}" انتخاب کنید:`;
        document.getElementById('deleteCategoryModal').style.display = 'flex';
    }

    // تابع حذف دسته‌بندی
    async function deleteCategory() {
        const deleteOption = document.querySelector('input[name="deleteOption"]:checked').value;
        
        try {
            if (deleteOption === 'categoryOnly') {
                // فقط دسته‌بندی حذف شود، جفت ارزها بدون دسته‌بندی می‌مانند
                const currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
                const pairsInCategory = currencyPairs.filter(p => p.categoryId === parseInt(currentDeleteCategoryId));
                
                for (const pair of pairsInCategory) {
                    await saveToDatabase(STORE_CURRENCY_PAIRS, {
                        ...pair,
                        categoryId: null
                    });
                }
                
                await deleteFromDatabase(STORE_CATEGORIES, parseInt(currentDeleteCategoryId));
                showNotification('دسته‌بندی حذف شد. جفت ارزها بدون دسته‌بندی باقی ماندند.');
                
            } else if (deleteOption === 'categoryWithPairs') {
                // دسته‌بندی و تمام جفت ارزهای داخل آن حذف شوند
                const currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
                const pairsInCategory = currencyPairs.filter(p => p.categoryId === parseInt(currentDeleteCategoryId));
                
                for (const pair of pairsInCategory) {
                    await deleteFromDatabase(STORE_CURRENCY_PAIRS, pair.id);
                }
                
                await deleteFromDatabase(STORE_CATEGORIES, parseInt(currentDeleteCategoryId));
                showNotification('دسته‌بندی و تمام جفت ارزهای آن با موفقیت حذف شد.');
            }
            
            closeModals();
            await loadCategories();
            await loadCurrencyPairs();
            
        } catch (error) {
            console.error('خطا در حذف دسته‌بندی:', error);
            showNotification('خطا در حذف دسته‌بندی.', 'error');
        }
    }

    // تابع بارگذاری جفت ارزها با مرتب‌سازی - اصلاح شده برای حذف نام دسته‌بندی
    async function loadCurrencyPairs() {
        try {
            let currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
            let categories = await getAllFromDatabase(STORE_CATEGORIES);
            
            currencyPairs.sort((a, b) => (a.order || 0) - (b.order || 0));
            categories.sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const currencyPairSelect = document.getElementById('currencyPairSelect');
            const filterCurrencyPair = document.getElementById('filterCurrencyPair');
            const comparisonCurrencyPair = document.getElementById('comparisonCurrencyPair');
            
            while (currencyPairSelect.children.length > 1) {
                currencyPairSelect.removeChild(currencyPairSelect.lastChild);
            }
            while (filterCurrencyPair.children.length > 1) {
                filterCurrencyPair.removeChild(filterCurrencyPair.lastChild);
            }
            while (comparisonCurrencyPair.children.length > 1) {
                comparisonCurrencyPair.removeChild(comparisonCurrencyPair.lastChild);
            }
            
            // تغییر: فقط نام جفت ارز نمایش داده می‌شود، بدون نام دسته‌بندی
            currencyPairs.forEach(pair => {
                const option1 = document.createElement('option');
                option1.value = pair.name;
                option1.textContent = pair.name; // فقط نام جفت ارز
                currencyPairSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = pair.name;
                option2.textContent = pair.name; // فقط نام جفت ارز
                filterCurrencyPair.appendChild(option2);
                
                const option3 = document.createElement('option');
                option3.value = pair.name;
                option3.textContent = pair.name; // فقط نام جفت ارز
                comparisonCurrencyPair.appendChild(option3);
            });
            
            updateCurrencyPairsList(currencyPairs, categories);
        } catch (error) {
            console.error('خطا در بارگذاری جفت ارزها:', error);
        }
    }

    // تابع به‌روزرسانی لیست جفت ارزها با قابلیت‌های جدید
    function updateCurrencyPairsList(currencyPairs, categories) {
        const currencyPairsList = document.getElementById('currencyPairsList');
        currencyPairsList.innerHTML = '';
        
        if (currencyPairs.length === 0 && categories.length === 0) {
            currencyPairsList.innerHTML = '<p>هیچ دسته‌بندی یا جفت ارزی وجود ندارد.</p>';
            return;
        }
        
        // نمایش دسته‌بندی‌ها
        categories.forEach(category => {
            const categoryPairs = currencyPairs.filter(p => p.categoryId === category.id);
            
            const categorySection = document.createElement('div');
            categorySection.className = 'category-section';
            categorySection.setAttribute('data-category-id', category.id);
            categorySection.innerHTML = `
                <div class="category-header" onclick="toggleCategory('${category.id}')">
                    <div class="category-title">
                        <span class="collapse-icon">▼</span>
                        ${category.name}
                    </div>
                    <div class="category-actions">
                        <button class="icon-btn edit-icon edit-category" data-id="${category.id}" data-name="${category.name}" title="ویرایش"></button>
                        <button class="icon-btn delete-icon delete-category" data-id="${category.id}" data-name="${category.name}" title="حذف"></button>
                    </div>
                </div>
                <div class="category-pairs" id="category-${category.id}">
                    ${categoryPairs.length === 0 ? 
                        '<p style="text-align: center; color: #666; padding: 10px; margin: 0;">هیچ جفت ارزی در این دسته‌بندی وجود ندارد</p>' : 
                        ''}
                </div>
            `;
            currencyPairsList.appendChild(categorySection);
            
            const categoryPairsContainer = document.getElementById(`category-${category.id}`);
            
            categoryPairs.forEach((pair, index) => {
                const pairElement = document.createElement('div');
                pairElement.className = 'currency-pair-item';
                pairElement.setAttribute('draggable', 'true');
                pairElement.setAttribute('data-pair-id', pair.id);
                pairElement.setAttribute('data-category-id', category.id);
                pairElement.innerHTML = `
                    <div class="currency-pair-name">${pair.name}</div>
                    <div class="currency-pair-actions">
                        <div class="move-buttons">
                            <button class="move-btn move-up" data-id="${pair.id}" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="move-btn move-down" data-id="${pair.id}" ${index === categoryPairs.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                        <button class="action-btn edit-currency-pair" data-id="${pair.id}" data-name="${pair.name}" data-category="${pair.categoryId}">ویرایش</button>
                        <button class="action-btn danger delete-currency-pair" data-id="${pair.id}" data-name="${pair.name}">حذف</button>
                    </div>
                `;
                categoryPairsContainer.appendChild(pairElement);
                
                // اضافه کردن event listeners برای درگ اند دراپ
                setupDragAndDrop(pairElement);
            });
        });
        
        // نمایش جفت ارزهای بدون دسته‌بندی
        const uncategorizedPairs = currencyPairs.filter(p => !p.categoryId);
        if (uncategorizedPairs.length > 0) {
            const uncategorizedSection = document.createElement('div');
            uncategorizedSection.className = 'category-section';
            uncategorizedSection.setAttribute('data-category-id', 'uncategorized');
            uncategorizedSection.innerHTML = `
                <div class="category-header" onclick="toggleCategory('uncategorized')">
                    <div class="category-title">
                        <span class="collapse-icon">▼</span>
                        بدون دسته‌بندی
                    </div>
                </div>
                <div class="category-pairs" id="uncategorized-pairs">
                </div>
            `;
            currencyPairsList.appendChild(uncategorizedSection);
            
            const uncategorizedContainer = document.getElementById('uncategorized-pairs');
            
            uncategorizedPairs.forEach((pair, index) => {
                const pairElement = document.createElement('div');
                pairElement.className = 'currency-pair-item';
                pairElement.setAttribute('draggable', 'true');
                pairElement.setAttribute('data-pair-id', pair.id);
                pairElement.setAttribute('data-category-id', 'uncategorized');
                pairElement.innerHTML = `
                    <div class="currency-pair-name">${pair.name}</div>
                    <div class="currency-pair-actions">
                        <div class="move-buttons">
                            <button class="move-btn move-up" data-id="${pair.id}" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="move-btn move-down" data-id="${pair.id}" ${index === uncategorizedPairs.length - 1 ? 'disabled' : ''}>↓</button>
                        </div>
                        <button class="action-btn edit-currency-pair" data-id="${pair.id}" data-name="${pair.name}" data-category="">ویرایش</button>
                        <button class="action-btn danger delete-currency-pair" data-id="${pair.id}" data-name="${pair.name}">حذف</button>
                    </div>
                `;
                uncategorizedContainer.appendChild(pairElement);
                
                setupDragAndDrop(pairElement);
            });
        }
        
        setupAllEventListeners();
    }

    // تابع تنظیم درگ اند دراپ برای یک آیتم
    function setupDragAndDrop(element) {
        let dragItem = null;
        
        element.addEventListener('dragstart', function(e) {
            dragItem = this;
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.getAttribute('data-pair-id'));
            e.dataTransfer.effectAllowed = 'move';
        });
        
        element.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            document.querySelectorAll('.currency-pair-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            dragItem = null;
        });
        
        element.addEventListener('dragover', function(e) {
            e.preventDefault();
            if (dragItem && dragItem !== this) {
                this.classList.add('drag-over');
            }
        });
        
        element.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });
        
        element.addEventListener('drop', async function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (!dragItem || dragItem === this) return;
            
            const draggedId = parseInt(dragItem.getAttribute('data-pair-id'));
            const targetId = parseInt(this.getAttribute('data-pair-id'));
            const categoryId = this.getAttribute('data-category-id');
            
            await reorderPairs(draggedId, targetId, categoryId);
        });
    }

    // تابع مرتب‌سازی مجدد جفت ارزها
    async function reorderPairs(draggedId, targetId, categoryId) {
        try {
            let currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
            
            // پیدا کردن موقعیت‌ها
            const draggedIndex = currencyPairs.findIndex(p => p.id === draggedId);
            const targetIndex = currencyPairs.findIndex(p => p.id === targetId);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            // حذف آیتم کشیده شده و قرار دادن آن در موقعیت جدید
            const [draggedItem] = currencyPairs.splice(draggedIndex, 1);
            currencyPairs.splice(targetIndex, 0, draggedItem);
            
            // به‌روزرسانی order برای همه آیتم‌ها
            currencyPairs.forEach((pair, index) => {
                pair.order = index;
            });
            
            // ذخیره تغییرات
            for (const pair of currencyPairs) {
                await saveToDatabase(STORE_CURRENCY_PAIRS, pair);
            }
            
            await loadCurrencyPairs();
            showNotification('ترتیب جفت ارزها به‌روزرسانی شد.');
        } catch (error) {
            console.error('خطا در مرتب‌سازی جفت ارزها:', error);
            showNotification('خطا در مرتب‌سازی جفت ارزها.', 'error');
        }
    }

    // تابع نمایش/مخفی کردن دسته‌بندی
    function toggleCategory(categoryId) {
        const pairsContainer = document.getElementById(`category-${categoryId}`);
        const collapseIcon = pairsContainer.parentElement.querySelector('.collapse-icon');
        
        if (pairsContainer.classList.contains('collapsed')) {
            pairsContainer.classList.remove('collapsed');
            collapseIcon.textContent = '▼';
        } else {
            pairsContainer.classList.add('collapsed');
            collapseIcon.textContent = '';
        }
    }

    // تابع جابجایی جفت ارز با دکمه‌ها
    async function moveCurrencyPair(id, direction) {
        try {
            let currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
            currencyPairs.sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const currentIndex = currencyPairs.findIndex(p => p.id === id);
            if (currentIndex === -1) return;
            
            if (direction === 'up' && currentIndex > 0) {
                const tempOrder = currencyPairs[currentIndex].order || currentIndex;
                currencyPairs[currentIndex].order = currencyPairs[currentIndex - 1].order || currentIndex - 1;
                currencyPairs[currentIndex - 1].order = tempOrder;
            } else if (direction === 'down' && currentIndex < currencyPairs.length - 1) {
                const tempOrder = currencyPairs[currentIndex].order || currentIndex;
                currencyPairs[currentIndex].order = currencyPairs[currentIndex + 1].order || currentIndex + 1;
                currencyPairs[currentIndex + 1].order = tempOrder;
            } else {
                return;
            }
            
            for (const pair of currencyPairs) {
                await saveToDatabase(STORE_CURRENCY_PAIRS, pair);
            }
            
            await loadCurrencyPairs();
            showNotification('ترتیب جفت ارزها به‌روزرسانی شد.');
        } catch (error) {
            console.error('خطا در جابجایی جفت ارز:', error);
            showNotification('خطا در جابجایی جفت ارز.', 'error');
        }
    }

    // تابع اضافه کردن جفت ارز جدید
    async function addCurrencyPair() {
        const newCurrencyPairInput = document.getElementById('newCurrencyPair');
        const categorySelect = document.getElementById('currencyPairCategory');
        const pairName = newCurrencyPairInput.value.trim();
        const categoryId = categorySelect.value ? parseInt(categorySelect.value) : null;
        
        if (!pairName) {
            showNotification('لطفاً نام جفت ارز را وارد کنید.', 'warning');
            return;
        }
        
        try {
            const currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
            const maxOrder = currencyPairs.length > 0 ? Math.max(...currencyPairs.map(p => p.order || 0)) : -1;
            
            await saveToDatabase(STORE_CURRENCY_PAIRS, {
                name: pairName,
                categoryId: categoryId,
                order: maxOrder + 1,
                createdAt: new Date().toISOString()
            });
            
            newCurrencyPairInput.value = '';
            categorySelect.value = '';
            await loadCurrencyPairs();
            showNotification('جفت ارز با موفقیت اضافه شد.');
        } catch (error) {
            console.error('خطا در اضافه کردن جفت ارز:', error);
            if (error.name === 'ConstraintError') {
                showNotification('این جفت ارز قبلاً وجود دارد.', 'error');
            } else {
                showNotification('خطا در اضافه کردن جفت ارز.', 'error');
            }
        }
    }

    // تابع باز کردن مودال ویرایش جفت ارز
    function openEditCurrencyPairModal(id, name, categoryId) {
        currentEditId = id;
        currentEditType = 'currencyPair';
        document.getElementById('editCurrencyPairInput').value = name;
        document.getElementById('editCurrencyPairCategory').value = categoryId || '';
        document.getElementById('editCurrencyPairModal').style.display = 'flex';
    }

    // تابع ذخیره ویرایش جفت ارز
    async function saveCurrencyPairEdit() {
        const newName = document.getElementById('editCurrencyPairInput').value.trim();
        const categoryId = document.getElementById('editCurrencyPairCategory').value ? parseInt(document.getElementById('editCurrencyPairCategory').value) : null;
        
        if (!newName) {
            showNotification('لطفاً نام جفت ارز را وارد کنید.', 'warning');
            return;
        }
        
        try {
            const currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
            const existingPair = currencyPairs.find(p => p.id === parseInt(currentEditId));
            
            if (existingPair) {
                await saveToDatabase(STORE_CURRENCY_PAIRS, {
                    ...existingPair,
                    name: newName,
                    categoryId: categoryId
                });
                
                closeModals();
                await loadCurrencyPairs();
                showNotification('جفت ارز با موفقیت ویرایش شد.');
            }
        } catch (error) {
            console.error('خطا در ویرایش جفت ارز:', error);
            if (error.name === 'ConstraintError') {
                showNotification('این جفت ارز قبلاً وجود دارد.', 'error');
            } else {
                showNotification('خطا در ویرایش جفت ارز.', 'error');
            }
        }
    }

    // تابع حذف جفت ارز
    async function deleteCurrencyPair(id) {
        try {
            await deleteFromDatabase(STORE_CURRENCY_PAIRS, parseInt(id));
            await loadCurrencyPairs();
            showNotification('جفت ارز با موفقیت حذف شد.');
        } catch (error) {
            console.error('خطا در حذف جفت ارز:', error);
            showNotification('خطا در حذف جفت ارز.', 'error');
        }
    }

    // تابع تنظیم event listenerها برای بخش مدیریت جفت ارزها
    function setupAllEventListeners() {
        document.querySelectorAll('.edit-category').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                openEditCategoryModal(id, name);
            });
        });
        
        document.querySelectorAll('.delete-category').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                openDeleteCategoryModal(id, name);
            });
        });
        
        document.querySelectorAll('.edit-currency-pair').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                const categoryId = this.getAttribute('data-category');
                openEditCurrencyPairModal(id, name, categoryId);
            });
        });
        
        document.querySelectorAll('.delete-currency-pair').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                showConfirmDeleteModal(
                    `آیا از حذف جفت ارز "${name}" مطمئن هستید؟ این عمل قابل بازگشت نیست.`,
                    () => deleteCurrencyPair(id)
                );
            });
        });
        
        document.querySelectorAll('.move-up:not([data-type])').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                moveCurrencyPair(id, 'up');
            });
        });
        
        document.querySelectorAll('.move-down:not([data-type])').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                moveCurrencyPair(id, 'down');
            });
        });
    }

    // تابع بارگذاری جدول محاسبات - اصلاح شده برای نمایش فقط با تاریخ مشخص
    async function loadCalculationsTable() {
        try {
            const currencyPair = document.getElementById('filterCurrencyPair').value;
            const date = document.getElementById('filterDate').value;
            
            const noDataMessage = document.getElementById('noDataMessage');
            const selectDateMessage = document.getElementById('selectDateMessage');
            
            // اگر تاریخ انتخاب نشده باشد
            if (!date) {
                document.getElementById('calculationsTableBody').innerHTML = '';
                document.getElementById('mobileCardsContainer').innerHTML = '';
                noDataMessage.style.display = 'none';
                selectDateMessage.style.display = 'block';
                return;
            }
            
            selectDateMessage.style.display = 'none';
            
            let calculations = await getAllFromDatabase(STORE_CALCULATIONS);
            
            if (currencyPair) {
                calculations = calculations.filter(c => c.currencyPair === currencyPair);
            }
            
            if (date) {
                calculations = calculations.filter(c => c.date === date);
            }
            
            calculations.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tableBody = document.getElementById('calculationsTableBody');
            const mobileCardsContainer = document.getElementById('mobileCardsContainer');
            
            tableBody.innerHTML = '';
            mobileCardsContainer.innerHTML = '';
            
            if (calculations.length === 0) {
                noDataMessage.style.display = 'block';
                return;
            }
            
            noDataMessage.style.display = 'none';
            
            calculations.forEach(calc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="table-cell" data-copy="${formatDate(calc.date)}">${formatDate(calc.date)}</td>
                    <td class="table-cell" data-copy="${calc.currencyPair}">${calc.currencyPair}</td>
                    <td class="table-cell" data-copy="${formatNumberDisplay(calc.inputY1, calc.inputFormatY1)}">${formatNumberDisplay(calc.inputY1, calc.inputFormatY1)}</td>
                    <td class="table-cell" data-copy="${formatNumberDisplay(calc.inputY2, calc.inputFormatY2)}">${formatNumberDisplay(calc.inputY2, calc.inputFormatY2)}</td>
                    <td class="table-cell" data-copy="${formatNumberDisplay(calc.result1, calc.inputFormatY1)}">${formatNumberDisplay(calc.result1, calc.inputFormatY1)}</td>
                    <td class="table-cell" data-copy="${formatNumberDisplay(calc.result2, calc.inputFormatY1)}">${formatNumberDisplay(calc.result2, calc.inputFormatY1)}</td>
                    <td class="table-cell" data-copy="${formatNumberDisplay(calc.result3, calc.inputFormatY2)}">${formatNumberDisplay(calc.result3, calc.inputFormatY2)}</td>
                    <td class="table-cell" data-copy="${formatNumberDisplay(calc.result4, calc.inputFormatY2)}">${formatNumberDisplay(calc.result4, calc.inputFormatY2)}</td>
                    <td class="action-buttons">
                        <button class="action-btn edit-calculation" data-id="${calc.id}">ویرایش</button>
                        <button class="action-btn danger delete-calculation" data-id="${calc.id}">حذف</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // اضافه کردن event listener برای کپی در جدول
            document.querySelectorAll('#calculationsTableBody .table-cell').forEach(cell => {
                cell.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON') return; // جلوگیری از تداخل با دکمه‌ها
                    copyToClipboard(this, this.dataset.copy);
                });
            });
            
            calculations.forEach(calc => {
                const card = document.createElement('div');
                card.className = 'calculation-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-date">${formatDate(calc.date)}</div>
                        <div class="card-currency">${calc.currencyPair}</div>
                    </div>
                    <div class="card-content">
                        <div class="card-item">
                            <div class="card-label">سقف</div>
                            <div class="card-value" data-value="${formatNumberDisplay(calc.inputY1, calc.inputFormatY1)}">${formatNumberDisplay(calc.inputY1, calc.inputFormatY1)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">کف</div>
                            <div class="card-value" data-value="${formatNumberDisplay(calc.inputY2, calc.inputFormatY2)}">${formatNumberDisplay(calc.inputY2, calc.inputFormatY2)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">فرمول ۱</div>
                            <div class="card-value" data-value="${formatNumberDisplay(calc.result1, calc.inputFormatY1)}">${formatNumberDisplay(calc.result1, calc.inputFormatY1)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">فرمول ۲</div>
                            <div class="card-value" data-value="${formatNumberDisplay(calc.result2, calc.inputFormatY1)}">${formatNumberDisplay(calc.result2, calc.inputFormatY1)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">فرمول ۳</div>
                            <div class="card-value" data-value="${formatNumberDisplay(calc.result3, calc.inputFormatY2)}">${formatNumberDisplay(calc.result3, calc.inputFormatY2)}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-label">فرمول ۴</div>
                            <div class="card-value" data-value="${formatNumberDisplay(calc.result4, calc.inputFormatY2)}">${formatNumberDisplay(calc.result4, calc.inputFormatY2)}</div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn edit-calculation" data-id="${calc.id}">ویرایش</button>
                        <button class="action-btn danger delete-calculation" data-id="${calc.id}">حذف</button>
                    </div>
                `;
                mobileCardsContainer.appendChild(card);
            });
            
            // اضافه کردن event listener برای کپی در کارت‌ها
            document.querySelectorAll('#mobileCardsContainer .card-value').forEach(value => {
                value.addEventListener('click', function(e) {
                    if (e.target.tagName === 'BUTTON') return; // جلوگیری از تداخل با دکمه‌ها
                    copyToClipboard(this);
                });
            });
            
            document.querySelectorAll('.edit-calculation').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const id = this.getAttribute('data-id');
                    try {
                        const calculations = await getAllFromDatabase(STORE_CALCULATIONS);
                        const calculation = calculations.find(c => c.id === parseInt(id));
                        if (calculation) {
                            openEditCalculationModal(calculation);
                        }
                    } catch (error) {
                        console.error('خطا در بارگذاری محاسبه:', error);
                        showNotification('خطا در بارگذاری محاسبه.', 'error');
                    }
                });
            });
            
            document.querySelectorAll('.delete-calculation').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    showConfirmDeleteModal(
                        'آیا از حذف این محاسبه مطمئن هستید؟ این عمل قابل بازگشت نیست.',
                        () => deleteCalculation(id)
                    );
                });
            });
        } catch (error) {
            console.error('خطا در بارگذاری جدول محاسبات:', error);
        }
    }

    // تابع باز کردن مودال ویرایش محاسبه
    function openEditCalculationModal(calculation) {
        document.getElementById('currencyPairSelect').value = calculation.currencyPair;
        document.getElementById('calculationDate').value = calculation.date;
        document.getElementById('inputY1').value = formatNumberDisplay(calculation.inputY1, calculation.inputFormatY1);
        document.getElementById('inputY2').value = formatNumberDisplay(calculation.inputY2, calculation.inputFormatY2);
        
        switchTab('calculator');
        
        showNotification('داده‌ها به ماشین حساب منتقل شدند. پس از ویرایش، دکمه "محاسبه و ذخیره" را بزنید.', 'success', 5000);
        
        currentEditId = calculation.id;
    }

    // تابع حذف محاسبه
    async function deleteCalculation(id) {
        try {
            await deleteFromDatabase(STORE_CALCULATIONS, parseInt(id));
            await loadCalculationsTable();
            showNotification('محاسبه با موفقیت حذف شد.');
        } catch (error) {
            console.error('خطا در حذف محاسبه:', error);
            showNotification('خطا در حذف محاسبه.', 'error');
        }
    }

    // تابع حذف داده‌های بر اساس تاریخ
    async function deleteDataByDate() {
        const deleteBeforeDate = document.getElementById('deleteBeforeDate').value;
        
        if (!deleteBeforeDate) {
            showNotification('لطفاً تاریخ را انتخاب کنید.', 'warning');
            return;
        }
        
        try {
            const calculations = await getAllFromDatabase(STORE_CALCULATIONS);
            const oldCalculations = calculations.filter(c => c.date < deleteBeforeDate);
            
            if (oldCalculations.length === 0) {
                showNotification('هیچ داده‌ای قبل از این تاریخ وجود ندارد.', 'warning');
                return;
            }
            
            if (confirm(`آیا از حذف ${oldCalculations.length} محاسبه قبل از تاریخ ${deleteBeforeDate} مطمئن هستید؟`)) {
                for (const calc of oldCalculations) {
                    await deleteFromDatabase(STORE_CALCULATIONS, calc.id);
                }
                
                await loadCalculationsTable();
                showNotification(`${oldCalculations.length} محاسبه با موفقیت حذف شد.`);
            }
        } catch (error) {
            console.error('خطا در حذف داد��‌های بر اساس تاریخ:', error);
            showNotification('خطا در حذف داده‌ها.', 'error');
        }
    }

    // تابع حذف داده‌های بر اساس تعداد روز
    async function deleteDataByDays() {
        const deleteDays = document.getElementById('deleteDays').value;
        
        if (!deleteDays || deleteDays < 1 || deleteDays > 365) {
            showNotification('لطفاً عددی بین 1 تا 365 وارد کنید.', 'warning');
            return;
        }
        
        try {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - deleteDays);
            const cutoffDateString = cutoffDate.toISOString().split('T')[0];
            
            const calculations = await getAllFromDatabase(STORE_CALCULATIONS);
            const oldCalculations = calculations.filter(c => c.date < cutoffDateString);
            
            if (oldCalculations.length === 0) {
                showNotification(`هیچ داده قدیمی‌تر از ${deleteDays} روز وجود ندارد.`, 'warning');
                return;
            }
            
            if (confirm(`آیا از حذف ${oldCalculations.length} محاسبه قدیمی‌تر از ${deleteDays} روز مطمئن هستید؟`)) {
                for (const calc of oldCalculations) {
                    await deleteFromDatabase(STORE_CALCULATIONS, calc.id);
                }
                
                await loadCalculationsTable();
                showNotification(`${oldCalculations.length} محاسبه قدیمی با موفقیت حذف شد.`);
            }
        } catch (error) {
            console.error('خطا در حذف داده‌های قدیمی:', error);
            showNotification('خطا در حذف داده‌های قدیمی.', 'error');
        }
    }

    // تابع فرمت تاریخ برای نمایش (میلادی)
    function formatDate(dateString) {
        return dateString;
    }

    // تابع فرمت اعداد برای نمایش
    function formatNumberDisplay(number, inputFormat) {
        if (!inputFormat || !inputFormat.hasSeparator) {
            return number.toString();
        }
        
        const numStr = number.toString();
        
        if (numStr.length <= inputFormat.parts[0].length) {
            return numStr;
        }
        
        const beforeSeparator = numStr.slice(0, inputFormat.parts[0].length);
        const afterSeparator = numStr.slice(inputFormat.parts[0].length);
        
        return beforeSeparator + '.' + afterSeparator;
    }

    // تابع پشتیبان‌گیری از داده‌ها
    async function backupData() {
        try {
            const calculations = await getAllFromDatabase(STORE_CALCULATIONS);
            const currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
            const categories = await getAllFromDatabase(STORE_CATEGORIES);
            const settings = await getAllFromDatabase(STORE_SETTINGS);
            
            const backupData = {
                calculations,
                currencyPairs,
                categories,
                settings,
                backupDate: new Date().toISOString(),
                version: DB_VERSION
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `calculator_pro_formula_2-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('پشتیبان با موفقیت دانلود شد.');
        } catch (error) {
            console.error('خطا در پشتیبان‌گیری:', error);
            showNotification('خطا در پشتیبان‌گیری.', 'error');
        }
    }

    // تابع بازیابی داده‌ها
    async function restoreData() {
        const fileInput = document.getElementById('restoreFileInput');
        fileInput.click();
        
        fileInput.onchange = async function() {
            const file = this.files[0];
            if (!file) return;
            
            if (!confirm('آیا از بازیابی داده‌ها مطمئن هستید؟ این عمل تمام داده‌های فعلی را جایگزین می‌کند.')) {
                return;
            }
            
            try {
                const fileText = await readFileAsText(file);
                const backupData = JSON.parse(fileText);
                
                await clearAllData();
                
                for (const category of backupData.categories || []) {
                    await saveToDatabase(STORE_CATEGORIES, category);
                }
                
                for (const pair of backupData.currencyPairs) {
                    await saveToDatabase(STORE_CURRENCY_PAIRS, pair);
                }
                
                for (const calc of backupData.calculations) {
                    await saveToDatabase(STORE_CALCULATIONS, calc);
                }
                
                for (const setting of backupData.settings || []) {
                    await saveToDatabase(STORE_SETTINGS, setting);
                }
                
                await loadCategories();
                await loadCurrencyPairs();
                await loadCalculationsTable();
                
                showNotification('داده‌ها با موفقیت بازیابی شدند.');
            } catch (error) {
                console.error('خطا در بازیابی داده‌ها:', error);
                showNotification('خطا در بازیابی داده‌ها. فایل معتبر نیست.', 'error');
            }
            
            fileInput.value = '';
        };
    }

    // تابع خواندن فایل به صورت متن
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = e => reject(e);
            reader.readAsText(file);
        });
    }

    // تابع حذف تمام داده‌ها
    async function clearAllData() {
        try {
            const calculations = await getAllFromDatabase(STORE_CALCULATIONS);
            const currencyPairs = await getAllFromDatabase(STORE_CURRENCY_PAIRS);
            const categories = await getAllFromDatabase(STORE_CATEGORIES);
            
            for (const calc of calculations) {
                await deleteFromDatabase(STORE_CALCULATIONS, calc.id);
            }
            
            for (const pair of currencyPairs) {
                await deleteFromDatabase(STORE_CURRENCY_PAIRS, pair.id);
            }
            
            for (const category of categories) {
                await deleteFromDatabase(STORE_CATEGORIES, category.id);
            }
            
            await loadCategories();
            await loadCurrencyPairs();
            await loadCalculationsTable();
        } catch (error) {
            console.error('خطا در حذف تمام داده‌ها:', error);
            throw error;
        }
    }

    // تابع مقایسه داده‌ها
    async function compareData() {
        const currencyPair = document.getElementById('comparisonCurrencyPair').value;
        const dateInputs = document.querySelectorAll('.comparison-date');
        const dates = Array.from(dateInputs).map(input => input.value).filter(date => date);
        
        if (!currencyPair) {
            showNotification('لطفاً جفت ارز را انتخاب کنید.', 'warning');
            return;
        }
        
        if (dates.length === 0) {
            showNotification('لطفاً حداقل یک تاریخ را انتخاب کنید.', 'warning');
            return;
        }
        
        try {
            const calculations = await getAllFromDatabase(STORE_CALCULATIONS);
            const comparisonResults = document.getElementById('comparisonResults');
            comparisonResults.innerHTML = '';
            
            let foundAnyData = false;
            
            for (const date of dates) {
                const calc = calculations.find(c => 
                    c.currencyPair === currencyPair && c.date === date
                );
                
                const comparisonItem = document.createElement('div');
                comparisonItem.className = 'comparison-item';
                
                if (calc) {
                    foundAnyData = true;
                    comparisonItem.innerHTML = `
                        <h3>${formatDate(date)}</h3>
                        <p><strong>جفت ارز:</strong> ${calc.currencyPair}</p>
                        <p><strong>سقف:</strong> ${formatNumberDisplay(calc.inputY1, calc.inputFormatY1)}</p>
                        <p><strong>کف:</strong> ${formatNumberDisplay(calc.inputY2, calc.inputFormatY2)}</p>
                        <p><strong>فرمول 1:</strong> ${formatNumberDisplay(calc.result1, calc.inputFormatY1)}</p>
                        <p><strong>فرمول 2:</strong> ${formatNumberDisplay(calc.result2, calc.inputFormatY1)}</p>
                        <p><strong>فرمول 3:</strong> ${formatNumberDisplay(calc.result3, calc.inputFormatY2)}</p>
                        <p><strong>فرمول 4:</strong> ${formatNumberDisplay(calc.result4, calc.inputFormatY2)}</p>
                    `;
                } else {
                    comparisonItem.innerHTML = `
                        <h3>${formatDate(date)}</h3>
                        <p>داده‌ای برای این تاریخ یافت نشد.</p>
                    `;
                }
                comparisonResults.appendChild(comparisonItem);
            }
            
            if (!foundAnyData) {
                showNotification('هیچ داده‌ای برای تاریخ‌های انتخاب شده یافت نشد.', 'warning');
            }
        } catch (error) {
            console.error('خطا در مقایسه داده‌ها:', error);
            showNotification('خطا در مقایسه داده‌ها.', 'error');
        }
    }

    // تابع افزودن فیلد تاریخ جدید برای مقایسه
    function addComparisonDate() {
        const datesContainer = document.getElementById('comparisonDatesContainer');
        const dateRow = document.createElement('div');
        dateRow.className = 'comparison-date-row';
        dateRow.innerHTML = `
            <div class="comparison-date-input">
                <input type="date" class="comparison-date">
            </div>
            <button type="button" class="remove-date-btn">×</button>
        `;
        datesContainer.appendChild(dateRow);
        
        updateRemoveButtonsVisibility();
    }

    // تابع به‌روزرسانی نمایش دکمه‌های حذف
    function updateRemoveButtonsVisibility() {
        const dateRows = document.querySelectorAll('.comparison-date-row');
        dateRows.forEach((row, index) => {
            const removeBtn = row.querySelector('.remove-date-btn');
            removeBtn.style.display = index === 0 ? 'none' : 'inline-block';
            
            const newRemoveBtn = removeBtn.cloneNode(true);
            removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);
            
            newRemoveBtn.addEventListener('click', function() {
                row.remove();
                updateRemoveButtonsVisibility();
            });
        });
    }

    // تابع تشخیص فرمت عدد ورودی (فقط نقطه)
    function detectNumberFormat(input) {
        if (input.includes('.')) {
            return {
                hasSeparator: true,
                separator: '.',
                parts: input.split('.')
            };
        }
        
        return {
            hasSeparator: false,
            separator: '',
            parts: [input]
        };
    }
    
    // تابع تبدیل عدد ورودی به عدد صحیح
    function parseNumber(input) {
        const cleanedInput = input.replace(/[.,\s]/g, '');
        return parseInt(cleanedInput, 10);
    }
    
    // تابع فرمت کردن عدد خروجی مطابق با فرمت ورودی (فقط نقطه)
    function formatNumber(num, format) {
        if (!format.hasSeparator) {
            return num.toString();
        }
        
        const numStr = num.toString();
        
        if (numStr.length <= format.parts[0].length) {
            return numStr;
        }
        
        const beforeSeparator = numStr.slice(0, format.parts[0].length);
        const afterSeparator = numStr.slice(format.parts[0].length);
        
        return beforeSeparator + '.' + afterSeparator;
    }

    // تابع محاسبه و ذخیره - اصلاح شده برای نمایش نتایج
    async function calculateAndSave() {
        try {
            const y1Value = document.getElementById('inputY1').value.trim();
            const y2Value = document.getElementById('inputY2').value.trim();
            const currencyPair = document.getElementById('currencyPairSelect').value;
            const calculationDate = document.getElementById('calculationDate').value;
            
            if (!y1Value || !y2Value) {
                throw new Error("لطفاً هر دو عدد را وارد کنید!");
            }
            
            if (!currencyPair) {
                throw new Error("لطفاً جفت ارز را انتخاب کنید!");
            }
            
            if (!calculationDate) {
                throw new Error("لطفاً تاریخ را انتخاب کنید!");
            }
            
            const y1 = parseNumber(y1Value);
            const y2 = parseNumber(y2Value);
            
            const formatY1 = detectNumberFormat(y1Value);
            const formatY2 = detectNumberFormat(y2Value);
            
            const outputs = [
                document.getElementById('outputFormula1'),
                document.getElementById('outputFormula2'),
                document.getElementById('outputFormula3'),
                document.getElementById('outputFormula4')
            ];
            
            outputs.forEach(el => {
                el.classList.remove('error');
            });
            
            if (isNaN(y1) || isNaN(y2)) {
                throw new Error("لطفاً اعداد معتبر وارد کنید!");
            }
            
            if (y1 < 0 || y2 < 0) {
                throw new Error("لطفاً فقط اعداد مثبت وارد کنید.");
            }
            
            // محاسبه فرمول‌ها
            const result1 = Math.floor((Math.sqrt(y1) - 0.5) ** 2);
            const result2 = Math.floor((Math.sqrt(y1) - 1) ** 2);
            const result3 = Math.floor((Math.sqrt(y2) + 0.5) ** 2);
            const result4 = Math.floor((Math.sqrt(y2) + 1) ** 2);
            
            // نمایش نتایج در ماشین حساب
            outputs[0].textContent = `فرمول 1: ${formatNumber(result1, formatY1)}`;
            outputs[0].dataset.value = formatNumber(result1, formatY1);
            
            outputs[1].textContent = `فرمول 2: ${formatNumber(result2, formatY1)}`;
            outputs[1].dataset.value = formatNumber(result2, formatY1);
            
            outputs[2].textContent = `فرمول 3: ${formatNumber(result3, formatY2)}`;
            outputs[2].dataset.value = formatNumber(result3, formatY2);
            
            outputs[3].textContent = `فرمول 4: ${formatNumber(result4, formatY2)}`;
            outputs[3].dataset.value = formatNumber(result4, formatY2);
            
            // اگر در حال ویرایش هستیم، رکورد قدیم را حذف می‌کنیم
            if (currentEditId) {
                await deleteFromDatabase(STORE_CALCULATIONS, currentEditId);
                currentEditId = null;
            }
            
            // ذخیره در پایگاه داده
            await saveToDatabase(STORE_CALCULATIONS, {
                date: calculationDate,
                currencyPair: currencyPair,
                inputY1: y1,
                inputY2: y2,
                inputFormatY1: formatY1,
                inputFormatY2: formatY2,
                result1: result1,
                result2: result2,
                result3: result3,
                result4: result4,
                createdAt: new Date().toISOString()
            });
            
            showNotification('محاسبات با موفقیت ذخیره شد.');
            
        } catch (error) {
            const outputFormula1 = document.getElementById('outputFormula1');
            outputFormula1.textContent = `خطا: ${error.message}`;
            outputFormula1.classList.add('error');
            
            ['outputFormula2', 'outputFormula3', 'outputFormula4'].forEach(id => {
                document.getElementById(id).textContent = '';
            });
            
            showNotification(error.message, 'error');
        }
    }
    
    // تابع ریست کردن فیلدها
    function resetFields() {
        document.getElementById('inputY1').value = '';
        document.getElementById('inputY2').value = '';
        
        const outputs = [
            document.getElementById('outputFormula1'),
            document.getElementById('outputFormula2'),
            document.getElementById('outputFormula3'),
            document.getElementById('outputFormula4')
        ];
        
        outputs.forEach(el => {
            el.textContent = '';
            el.classList.remove('error');
        });
    }
    
    // تابع تغییر حالت تاریک/روشن
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const themeToggle = document.getElementById('themeToggle');
        if (document.body.classList.contains('dark-mode')) {
            themeToggle.textContent = '';
            localStorage.setItem('theme_1', 'dark');
        } else {
            themeToggle.textContent = '';
            localStorage.setItem('theme_1', 'light');
        }
    }
    

    // تابع تغییر تب - اصلاح شده برای مدیریت منوی موبایل
    function switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
        document.querySelector(`.mobile-tab[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        // تغییر: بستن منوی موبایل پس از انتخاب تب
        if (window.innerWidth <= 768) {
            document.getElementById('mobileTabs').style.display = 'none';
        }
        
        if (tabName === 'history') {
            loadCalculationsTable();
        }
    }

    // تابع نمایش/مخفی کردن منوی موبایل - اصلاح شده
    function toggleMobileMenu() {
        const mobileTabs = document.getElementById('mobileTabs');
        if (mobileTabs.style.display === 'flex') {
            mobileTabs.style.display = 'none';
        } else {
            mobileTabs.style.display = 'flex';
        }
    }

    // تابع نمایش مودال تأیید حذف
    function showConfirmDeleteModal(message, callback) {
        document.getElementById('confirmDeleteMessage').textContent = message;
        deleteCallback = callback;
        document.getElementById('confirmDeleteModal').style.display = 'flex';
    }

    // تابع بستن همه مودال‌ها
    function closeModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
        });
        currentEditId = null;
        currentEditType = null;
        deleteCallback = null;
        currentDeleteCategoryId = null;
    }

    // تابع تنظیم event listenerها - اصلاح شده برای مدیریت منوی موبایل
    function setupEventListeners() {
        // تب‌های اصلی
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });
        
        // تب‌های موبایل
        document.querySelectorAll('.mobile-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                switchTab(tabName);
            });
        });
        
        // منوی همبرگری موبایل - تغییر: فقط با کلیک باز می‌شود
        document.getElementById('mobileMenuToggle').addEventListener('click', toggleMobileMenu);
        
        // دکمه‌های ماشین حساب
        document.getElementById('calculateBtn').addEventListener('click', calculateAndSave);
        document.getElementById('resetBtn').addEventListener('click', resetFields);
        
        // دکمه‌های مدیریت جفت ارزها
        document.getElementById('addCurrencyPairBtn').addEventListener('click', addCurrencyPair);
        
        // دکمه‌های مدیریت دسته‌بندی‌ها
        document.getElementById('addCategoryBtn').addEventListener('click', addCategory);
        
        // دکمه‌های مقایسه
        document.getElementById('compareDataBtn').addEventListener('click', compareData);
        document.getElementById('addDateBtn').addEventListener('click', addComparisonDate);
        document.getElementById('clearComparisonBtn').addEventListener('click', function() {
            document.getElementById('comparisonResults').innerHTML = '';
            document.getElementById('comparisonDatesContainer').innerHTML = `
                <div class="comparison-date-row">
                    <div class="comparison-date-input">
                        <input type="date" class="comparison-date">
                    </div>
                    <button type="button" class="remove-date-btn" style="display: none;">×</button>
                </div>
            `;
            updateRemoveButtonsVisibility();
        });
        
        // دکمه‌های پشتیبان‌گیری
        document.getElementById('backupDataBtn').addEventListener('click', backupData);
        document.getElementById('restoreDataBtn').addEventListener('click', restoreData);
        
        // دکمه‌های حذف رکورد
        document.getElementById('deleteByDateBtn').addEventListener('click', deleteDataByDate);
        document.getElementById('deleteByDaysBtn').addEventListener('click', deleteDataByDays);
        
        // دکمه‌های مودال
        document.getElementById('saveCurrencyPairEditBtn').addEventListener('click', saveCurrencyPairEdit);
        document.getElementById('saveCategoryEditBtn').addEventListener('click', saveCategoryEdit);
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (deleteCallback) {
                deleteCallback();
            }
            closeModals();
        });
        
        document.getElementById('confirmCategoryDeleteBtn').addEventListener('click', deleteCategory);
        
        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', closeModals);
        });
        
        // کلیک خارج از مودال برای بستن آن
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                closeModals();
            }
        });
        
        // امکان استفاده از کلید Enter در فیلدهای ورودی
        ['inputY1', 'inputY2'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculateAndSave();
                }
            });
        });
        
        // تغییر حالت تاریک/روشن
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        
        // کپی کردن نتایج
        ['outputFormula1', 'outputFormula2', 'outputFormula3', 'outputFormula4'].forEach(id => {
            document.getElementById(id).addEventListener('click', function() {
                if (this.textContent && !this.classList.contains('error')) {
                    copyToClipboard(this);
                }
            });
        });
    }

    // بارگذاری حالت ذخیره شده
    if (localStorage.getItem('theme_1') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeToggle').textContent = '';
    }
</script>  <BR>
    <BR>
    
</body>
</html>

